// src/pages/Admin/Usuarios.jsx
import React, { useState, useEffect } from "react";

export default function Usuarios() {
  const [usuarios, setUsuarios] = useState([]);
  const [empresas, setEmpresas] = useState([]);
  const [roles, setRoles] = useState([]);
  const [form, setForm] = useState({
    id: null,
    nombre: "",
    email: "",
    password: "",
    empresa_id: "",
    rol_id: "",
  });
  const [modoEdicion, setModoEdicion] = useState(false);

  const token = localStorage.getItem("token");

  // üß† Cargar datos iniciales
  useEffect(() => {
    cargarUsuarios();
    cargarEmpresas();
    cargarRoles();
  }, []);

  const cargarUsuarios = async () => {
    try {
      const res = await fetch(`${API_BASE}/, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (Array.isArray(data)) setUsuarios(data);
      else setUsuarios([]);
    } catch (err) {
      console.error("Error al obtener usuarios:", err);
      setUsuarios([]);
    }
  };

  const cargarEmpresas = async () => {
    try {
      const res = await fetch(`${API_BASE}/, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (Array.isArray(data)) setEmpresas(data);
      else {
        console.warn("‚ö†Ô∏è No se devolvi√≥ lista de empresas:", data);
        setEmpresas([]);
      }
    } catch (err) {
      console.error("Error al obtener empresas:", err);
      setEmpresas([]);
    }
  };

  const cargarRoles = async () => {
    try {
      const res = await fetch(`${API_BASE}/, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (Array.isArray(data)) setRoles(data);
      else {
        console.warn("‚ö†Ô∏è No se devolvi√≥ lista de roles:", data);
        setRoles([]);
      }
    } catch (err) {
      console.error("Error al obtener roles:", err);
      setRoles([]);
    }
  };

  // ‚úèÔ∏è Manejar inputs
  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  // ‚ûï Crear usuario
  const crearUsuario = async () => {
    if (!form.nombre || !form.email || !form.password || !form.empresa_id || !form.rol_id) {
      alert("Por favor completa todos los campos.");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(form),
      });

      const data = await res.json();
      if (res.ok) {
        setUsuarios((prev) => [...prev, data.usuario || form]);
        alert("‚úÖ Usuario creado correctamente");
        resetForm();
      } else {
        alert(`‚ö†Ô∏è ${data.message || "Error al crear usuario"}`);
      }
    } catch (err) {
      console.error("‚ùå Error de conexi√≥n:", err);
    }
  };

  // üõ†Ô∏è Editar usuario
  const editarUsuario = (u) => {
    setModoEdicion(true);
    setForm({
      id: u.id,
      nombre: u.nombre,
      email: u.email,
      password: "",
      empresa_id: u.empresa_id || "",
      rol_id: u.rol_id || "",
    });
  };

  const actualizarUsuario = async () => {
    try {
      const res = await fetch(`${API_BASE}/usuarios/${form.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(form),
      });

      const data = await res.json();
      if (res.ok) {
        setUsuarios((prev) => prev.map((u) => (u.id === form.id ? { ...u, ...form } : u)));
        alert("‚úÖ Usuario actualizado correctamente");
        resetForm();
      } else {
        alert(`‚ö†Ô∏è ${data.message || "Error al actualizar usuario"}`);
      }
    } catch (err) {
      console.error("‚ùå Error actualizando:", err);
    }
  };

  // üóëÔ∏è Eliminar usuario
  const eliminarUsuario = async (id) => {
    const confirmar = window.confirm("¬øSeguro que deseas eliminar este usuario?");
    if (!confirmar) return;

    try {
      const res = await fetch(`${API_BASE}/usuarios/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });

      if (res.ok) {
        setUsuarios((prev) => prev.filter((u) => u.id !== id));
        alert("üóëÔ∏è Usuario eliminado correctamente");
      } else {
        alert("‚ö†Ô∏è Error al eliminar usuario");
      }
    } catch (err) {
      console.error("‚ùå Error eliminando:", err);
    }
  };

  // üîÑ Reset form
  const resetForm = () => {
    setForm({
      id: null,
      nombre: "",
      email: "",
      password: "",
      empresa_id: "",
      rol_id: "",
    });
    setModoEdicion(false);
  };

  return (
    <div className="p-6 bg-gray-900 min-h-screen text-white">
      <h2 className="text-3xl font-bold text-indigo-400 mb-6">
        Gesti√≥n de Usuarios
      </h2>

      {/* FORMULARIO */}
      <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <input
          type="text"
          name="nombre"
          placeholder="Nombre completo"
          value={form.nombre}
          onChange={handleChange}
          className="p-2 rounded bg-gray-700 text-white w-full"
        />
        <input
          type="email"
          name="email"
          placeholder="Correo electr√≥nico"
          value={form.email}
          onChange={handleChange}
          className="p-2 rounded bg-gray-700 text-white w-full"
        />
        <input
          type="password"
          name="password"
          placeholder={modoEdicion ? "Nueva contrase√±a (opcional)" : "Contrase√±a"}
          value={form.password}
          onChange={handleChange}
          className="p-2 rounded bg-gray-700 text-white w-full"
        />
        <select
          name="empresa_id"
          value={form.empresa_id}
          onChange={handleChange}
          className="p-2 rounded bg-gray-700 text-white w-full"
        >
          <option value="">Selecciona empresa...</option>
          {Array.isArray(empresas) &&
            empresas.map((e) => (
              <option key={e.id} value={e.id}>
                {e.nombre}
              </option>
            ))}
        </select>
        <select
          name="rol_id"
          value={form.rol_id}
          onChange={handleChange}
          className="p-2 rounded bg-gray-700 text-white w-full"
        >
          <option value="">Selecciona rol...</option>
          {Array.isArray(roles) &&
            roles.map((r) => (
              <option key={r.id} value={r.id}>
                {r.nombre}
              </option>
            ))}
        </select>
      </div>

      <div className="flex gap-4 mb-8">
        {modoEdicion ? (
          <>
            <button
              onClick={actualizarUsuario}
              className="bg-yellow-500 hover:bg-yellow-600 px-6 py-2 rounded font-semibold"
            >
              Actualizar
            </button>
            <button
              onClick={resetForm}
              className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded font-semibold"
            >
              Cancelar
            </button>
          </>
        ) : (
          <button
            onClick={crearUsuario}
            className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded font-semibold"
          >
            Crear Usuario
          </button>
        )}
      </div>

      {/* TABLA DE USUARIOS */}
      <table className="w-full bg-gray-800 rounded-lg shadow-md">
        <thead className="bg-gray-700 text-indigo-300">
          <tr>
            <th className="py-2 px-4 text-left">ID</th>
            <th className="py-2 px-4 text-left">Nombre</th>
            <th className="py-2 px-4 text-left">Correo</th>
            <th className="py-2 px-4 text-left">Empresa</th>
            <th className="py-2 px-4 text-left">Rol</th>
            <th className="py-2 px-4 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {Array.isArray(usuarios) &&
            usuarios.map((u) => (
              <tr key={u.id} className="border-t border-gray-700 hover:bg-gray-700/50">
                <td className="py-2 px-4">{u.id}</td>
                <td className="py-2 px-4">{u.nombre}</td>
                <td className="py-2 px-4">{u.email}</td>
                <td className="py-2 px-4">{u.empresa || "‚Äî"}</td>
                <td className="py-2 px-4">{u.rol || "‚Äî"}</td>
                <td className="py-2 px-4 flex justify-center gap-2">
                  <button
                    onClick={() => editarUsuario(u)}
                    className="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm font-semibold"
                  >
                    ‚úèÔ∏è Editar
                  </button>
                  <button
                    onClick={() => eliminarUsuario(u.id)}
                    className="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm font-semibold"
                  >
                    üóëÔ∏è Eliminar
                  </button>
                </td>
              </tr>
            ))}
        </tbody>
      </table>
    </div>
  );
}

